option_settings:
  aws:elasticbeanstalk:application:environment:
    PORT: 5000
    SERVER_PORT: 5000
    SPRING_PROFILES_ACTIVE: prod
  aws:elasticbeanstalk:container:java:
    JVMOptions: -Xmx512m -Xms256m -Djava.security.egd=file:/dev/urandom
  # CloudWatch Logs Configuration - Stream all logs to CloudWatch for debugging
  aws:elasticbeanstalk:cloudwatch:logs:
    StreamLogs: true
    DeleteOnTerminate: false
    RetentionInDays: 14
  # Health Logs - Stream health check logs
  aws:elasticbeanstalk:cloudwatch:logs:health:
    HealthStreamingEnabled: true
    DeleteOnTerminate: false
    RetentionInDays: 14
  aws:elbv2:loadbalancer:
    Scheme: internet-facing
    IdleTimeout: 60
  # HTTP listener (port 80) - kept for compatibility and health checks
  aws:elbv2:listener:default:
    Protocol: HTTP
    Port: 80
  # HTTPS listener (port 443) - requires SSL certificate ARN from AWS Certificate Manager
  # To get/create a certificate:
  # 1. Go to AWS Certificate Manager (ACM) in us-west-1 region
  # 2. Request a public certificate for your domain (or use wildcard *.elasticbeanstalk.com)
  # 3. Copy the certificate ARN and replace the placeholder below
  # 4. For Elastic Beanstalk domains, you can use a wildcard certificate: *.elasticbeanstalk.com
  # Example ARN format: arn:aws:acm:us-west-1:ACCOUNT_ID:certificate/CERTIFICATE_ID
  aws:elbv2:listener:443:
    Protocol: HTTPS
    Port: 443
    SSLCertificateArns: "arn:aws:acm:us-west-1:971422717446:certificate/REPLACE_WITH_YOUR_CERTIFICATE_ARN"
  aws:autoscaling:launchconfiguration:
    IamInstanceProfile: aws-elasticbeanstalk-ec2-role
  # Health check configuration - use /health endpoint
  aws:elasticbeanstalk:healthreporting:system:
    SystemType: enhanced
    HealthCheckSuccessThreshold: Ok
  # Enhanced health reporting configuration for load balancer
  aws:elasticbeanstalk:environment:process:default:
    HealthCheckPath: /health
    HealthCheckInterval: 15
    HealthCheckTimeout: 5
    HealthyThresholdCount: 2
    UnhealthyThresholdCount: 3
    DeregistrationDelay: 20
    MatcherHTTPCode: 200

files:
  "/opt/elasticbeanstalk/hooks/appdeploy/pre/01_build.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      cd /var/app/ondeck
      # If JAR already exists in root, we're done (deployed pre-built)
      if [ -f invoice-me-backend-1.0.0.jar ]; then
        exit 0
      fi
      # Otherwise, build from source
      if [ -f pom.xml ]; then
        mvn clean package -DskipTests || exit 1
        # Copy JAR to root for Procfile to find it
        cp target/invoice-me-backend-1.0.0.jar ./invoice-me-backend-1.0.0.jar || exit 1
      fi
