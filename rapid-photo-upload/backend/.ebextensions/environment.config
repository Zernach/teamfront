option_settings:
  aws:elasticbeanstalk:application:environment:
    SERVER_PORT: 5000
    SPRING_PROFILES_ACTIVE: prod
  aws:elasticbeanstalk:container:java:
    JVMOptions: -Xmx512m -Xms256m
  # CloudWatch Logs Configuration - Stream all logs to CloudWatch for debugging
  aws:elasticbeanstalk:cloudwatch:logs:
    StreamLogs: true
    DeleteOnTerminate: false
    RetentionInDays: 14
  # Health Logs - Stream health check logs
  aws:elasticbeanstalk:cloudwatch:logs:health:
    HealthStreamingEnabled: true
    DeleteOnTerminate: false
    RetentionInDays: 14
  aws:elbv2:loadbalancer:
    Scheme: internet-facing
    IdleTimeout: 60
  aws:elbv2:listener:default:
    Protocol: HTTP
    Port: 80
  # HTTPS disabled - using HTTP only for fully public access
  # aws:elbv2:listener:443:
  #   Protocol: HTTPS
  #   Port: 443
  #   SSLCertificateArns: ""
  aws:autoscaling:launchconfiguration:
    IamInstanceProfile: aws-elasticbeanstalk-ec2-role

files:
  "/opt/elasticbeanstalk/hooks/appdeploy/pre/01_build.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      cd /var/app/ondeck
      # If JAR already exists in root, we're done (deployed pre-built)
      if [ -f rapid-photo-upload-backend-1.0.0.jar ]; then
        exit 0
      fi
      # Otherwise, build from source
      if [ -f pom.xml ]; then
        mvn clean package -DskipTests || exit 1
        # Copy JAR to root for Procfile to find it
        cp target/rapid-photo-upload-backend-1.0.0.jar ./rapid-photo-upload-backend-1.0.0.jar || exit 1
      fi
