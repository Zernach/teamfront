option_settings:
  aws:elasticbeanstalk:application:environment:
    ASPNETCORE_ENVIRONMENT: Production
    PORT: 5000
    # The application reads PORT and configures ASPNETCORE_URLS in Program.cs
  # CloudWatch Logs Configuration - Stream all logs to CloudWatch for debugging
  aws:elasticbeanstalk:cloudwatch:logs:
    StreamLogs: true
    DeleteOnTerminate: false
    RetentionInDays: 14
  # Health Logs - Stream health check logs
  aws:elasticbeanstalk:cloudwatch:logs:health:
    HealthStreamingEnabled: true
    DeleteOnTerminate: false
    RetentionInDays: 14
  aws:elbv2:loadbalancer:
    Scheme: internet-facing
    IdleTimeout: 60
  aws:elbv2:listener:default:
    Protocol: HTTP
    Port: 80
  # HTTPS listener (port 443) - using SSL certificate from ACM
  aws:elbv2:listener:443:
    Protocol: HTTPS
    Port: 443
    SSLCertificateArns: "arn:aws:acm:us-west-1:971422717446:certificate/e11f7dde-ace3-4b48-bfaa-a722ccfe697e"
  aws:autoscaling:launchconfiguration:
    IamInstanceProfile: aws-elasticbeanstalk-ec2-role

files:
  "/opt/elasticbeanstalk/hooks/appdeploy/pre/01_build.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      set -e
      cd /var/app/ondeck
      # If self-contained executable already exists, we're done (deployed pre-built)
      if [ -f SmartScheduler ]; then
        chmod +x SmartScheduler
        exit 0
      fi
      # If runtime-dependent DLL exists, we're done (deployed pre-built)
      if [ -f SmartScheduler.dll ]; then
        exit 0
      fi
      # Otherwise, build from source
      if [ -f SmartScheduler.csproj ]; then
        dotnet restore || exit 1
        dotnet publish -c Release -r linux-x64 --self-contained true -o ./ || exit 1
        chmod +x SmartScheduler || true
      fi
