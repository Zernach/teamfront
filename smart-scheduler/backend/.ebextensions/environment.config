option_settings:
  aws:elasticbeanstalk:application:environment:
    ASPNETCORE_ENVIRONMENT: Production
    # PORT is automatically provided by Elastic Beanstalk
    # The application reads PORT and configures ASPNETCORE_URLS in Program.cs

files:
  "/opt/elasticbeanstalk/hooks/appdeploy/pre/01_build.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      set -e
      cd /var/app/ondeck
      # If self-contained executable already exists, we're done (deployed pre-built)
      if [ -f SmartScheduler ]; then
        chmod +x SmartScheduler
        exit 0
      fi
      # If runtime-dependent DLL exists, we're done (deployed pre-built)
      if [ -f SmartScheduler.dll ]; then
        exit 0
      fi
      # Otherwise, build from source
      if [ -f SmartScheduler.csproj ]; then
        dotnet restore || exit 1
        dotnet publish -c Release -r linux-x64 --self-contained true -o ./ || exit 1
        chmod +x SmartScheduler || true
      fi
