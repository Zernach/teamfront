files:
  "/opt/elasticbeanstalk/hooks/configdeploy/pre/01_configure_nginx_rate_limit.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      # Configure nginx rate limiting zones before nginx starts
      # This runs during configuration deployment, before nginx is started
      
      NGINX_MAIN_CONF="/etc/nginx/nginx.conf"
      
      echo "[Rate Limit Config] Starting rate limit configuration"
      
      if [ ! -f "$NGINX_MAIN_CONF" ]; then
          echo "[Rate Limit Config] ERROR: Nginx config not found at $NGINX_MAIN_CONF"
          exit 0
      fi
      
      # Check if zones are already properly configured
      if grep -qE "limit_req_zone\s+\$binary_remote_addr\s+zone=api_limit:10m\s+rate=10r/s;" "$NGINX_MAIN_CONF" 2>/dev/null; then
          echo "[Rate Limit Config] Rate limiting zones already configured"
          exit 0
      fi
      
      echo "[Rate Limit Config] Backing up nginx config"
      cp "$NGINX_MAIN_CONF" "$NGINX_MAIN_CONF.bak"
      
      # Remove any existing malformed zone definitions (more comprehensive cleanup)
      echo "[Rate Limit Config] Removing any existing malformed zone definitions"
      sed -i '/limit_req_zone.*api_limit/d' "$NGINX_MAIN_CONF"
      sed -i '/limit_req_zone.*strict_limit/d' "$NGINX_MAIN_CONF"
      
      # Add zones properly in the http block
      echo "[Rate Limit Config] Adding rate limit zones to http block"
      TEMP_NGINX=$(mktemp)
      
      # Use sed to insert zones right after "http {" line
      sed '/^http {/a\    # Rate limiting zones\n    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;\n    limit_req_zone $binary_remote_addr zone=strict_limit:10m rate=2r/s;' "$NGINX_MAIN_CONF" > "$TEMP_NGINX"
      
      # Validate before replacing
      echo "[Rate Limit Config] Validating nginx configuration"
      if nginx -t -c "$TEMP_NGINX" 2>&1 | grep -q "successful"; then
          mv "$TEMP_NGINX" "$NGINX_MAIN_CONF"
          echo "[Rate Limit Config] SUCCESS: Rate limiting zones configured"
          nginx -t
      else
          echo "[Rate Limit Config] ERROR: Nginx config validation failed"
          nginx -t -c "$TEMP_NGINX" 2>&1 | head -10
          echo "[Rate Limit Config] Restoring backup"
          cp "$NGINX_MAIN_CONF.bak" "$NGINX_MAIN_CONF"
          rm -f "$TEMP_NGINX"
          exit 1
      fi

